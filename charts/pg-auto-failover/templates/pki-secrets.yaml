{{- if and .Values.tls.generate (or .Release.IsInstall .Values.tls.forceGenerate) }}
{{- $ca := genCA "postgresql-ca" 3650 }}

{{- $monitorServiceDnsName := printf "%s-headless.%s.svc.cluster.local" (include "postgresql-auto-failover.monitor.fullname" .) .Release.Namespace}}
{{- $wildcardMonitorServiceDnsName := printf "*.%s" $monitorServiceDnsName}}
{{- $cert := genSignedCert $monitorServiceDnsName nil ( list $wildcardMonitorServiceDnsName $monitorServiceDnsName ) 3650 $ca }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "postgresql-auto-failover.monitor.fullname" . }}-tls
  labels:
    {{- include "postgresql-auto-failover.monitor.labels" . | nindent 4 }}
  annotations:
{{- if .Values.tls.forceGenerate }}
    helm.sh/hook: pre-upgrade
{{- else if .Values.tls.generate }}
    helm.sh/hook: pre-install
{{- end }}  
type: kubernetes.io/tls
data:
  ca.crt: {{ $ca.Cert | b64enc }}
  tls.crt: {{ $cert.Cert | b64enc }}
  tls.key: {{ $cert.Key | b64enc }}
---
{{- $nodeServiceDnsName := printf "%s-headless.%s.svc.cluster.local" (include "postgresql-auto-failover.node.fullname" .) .Release.Namespace}}
{{- $wildcardNodeServiceDnsName := printf "*.%s" $nodeServiceDnsName}}
{{- $cert := genSignedCert $nodeServiceDnsName nil ( list $wildcardNodeServiceDnsName $nodeServiceDnsName ) 3650 $ca }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "postgresql-auto-failover.node.fullname" . }}-tls
  labels:
    {{- include "postgresql-auto-failover.node.labels" . | nindent 4 }}
  annotations:
{{- if .Values.tls.forceGenerate }}
    helm.sh/hook: pre-upgrade
{{- else if .Values.tls.generate }}
    helm.sh/hook: pre-install
{{- end }}  
type: kubernetes.io/tls
data:
  ca.crt: {{ $ca.Cert | b64enc }}
  tls.crt: {{ $cert.Cert | b64enc }}
  tls.key: {{ $cert.Key | b64enc }}

{{- end }} # Global if